@using BookShelf_Blazor.Model
@using Newtonsoft.Json
@inject ISnackbar Snackbar
@inherits BaseComponent
@page "/"
@using Components

<PageTitle>Index</PageTitle>
<MudTextField Clearable="true" @bind-Value="sentence" Label="Search a book" Elevation="4" Variant="Variant.Text"></MudTextField>
<MudButton  Disabled="@onSearch" Variant="Variant.Filled" Spacing Color="Color.Secondary" Class="mt-3" OnClick="search">
    @if (onSearch)
    {
        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
        <MudText Class="ms-2">Searching</MudText>
    }
    else
    {
        <MudText>Search</MudText>
    }
</MudButton>

@if (showInfo)
{
    <div class="mt-1 d-flex flex-column align-center">
        <MudPagination BoundaryCount="1" MiddleCount="3" ShowFirstButton="true" ShowLastButton="true" Count="@pages" Class="mt-4" SelectedChanged="changePage" Size="Size.Small"/>
    </div>
    <br>
    string info = $"Showing {books.Skip(10*(page-1)).Take(10).Count()} of {books.Count()}";
    <MudText Class="mt-3" Typo="Typo.caption" Color="Color.Info">@info</MudText>
    <MudGrid Class="mt-3">
        
        @foreach (var book in books.GetRange(10*(page-1),books.Skip(10*(page-1)).Take(10).Count()))
        {
            <MudItem xs=12 lg=6>
                <MudGrid>
                    @{
                        var isSaved = isOnShelf(book);
                    }
                    <BookShelf_Blazor.Components.BookInfo book="@book">

                        <MudMenu Disabled="isSaved" Label="@(isSaved ?"Already on shelf" : "Save")" Variant="Variant.Filled" EndIcon="@Icons.Filled.KeyboardArrowDown" Color="Color.Secondary" IconColor="Color.Primary" >
                            <MudMenuItem OnClick="() => saveAsFinished(book)">As Read</MudMenuItem>
                            <MudMenuItem OnClick="() => saveAsReading(book)">As Reading</MudMenuItem>
                            <MudMenuItem OnClick="() => saveAsWished(book)">As To Buy</MudMenuItem>
                            <MudMenuItem OnClick="() => saveAsTBR(book)">As To Be Read</MudMenuItem>
                        </MudMenu>
                    </BookShelf_Blazor.Components.BookInfo>
                    
                </MudGrid>



            </MudItem>
        }
    </MudGrid>
    


}

@code {
    
    private bool onSearch = false;
    bool drawerStatus = false;
    private string sentence = "";
    private bool showInfo  {get;set;} = false;
    private List<Book>? books;
    private dynamic? infoRes = null;
    private async Task search()
    {
        HttpClient client = new HttpClient();

        onSearch = true;
        string path = $"https://openlibrary.org/search.json?q={sentence.Replace(" ", "+")}";
        HttpResponseMessage response = await client.GetAsync(path);
        if (response.IsSuccessStatusCode)
        {

            infoRes = JsonConvert.DeserializeObject<dynamic>(await response.Content.ReadAsStringAsync());
            books = JsonConvert.DeserializeObject<List<Book>>(infoRes.docs.ToString());
            books = books.OrderByDescending(x=> x.first_publish_year).DistinctBy(x=>x.title).ToList();
            pages = books.Count() % 10 != 0 ? books.Count() / 10 + 1 : books.Count() / 10 ;
            page = 1;
            showInfo = true;
        }
        onSearch = false;
    }
    private void changePage(int i){
        page=i;
    }
    private async void saveAsFinished(Book book){

        string message = "Failed to save";
        var severity = Severity.Error;
        if(saveOnFinished(book)){
            message = "Book Saved Successfully!";
            severity =  Severity.Success;
        }
        
        Snackbar.Add(message, severity, config =>
        {
            config.ShowCloseIcon = true;
        });
    }
    
    private void saveAsReading(Book book){
        string message = "Failed to save";
        var severity = Severity.Error;
        if(saveOnReading(book)){
            message = "Book Saved Successfully!";
            severity =  Severity.Success;
            Console.WriteLine("aaaaaaa");
        }
        
        Snackbar.Add(message, severity, config =>
        {
            config.ShowCloseIcon = true;
        });
    }
    private void saveAsWished(Book book){
        string message = "Failed to save";
        var severity = Severity.Error;
        if(saveOnWish(book)){
            message = "Book Saved Successfully!";
            severity =  Severity.Success;
            Console.WriteLine("aaaaaaa");
        }
        
        Snackbar.Add(message, severity, config =>
        {
            config.ShowCloseIcon = true;
        });
    }
    private void saveAsTBR(Book book){
        string message = "Failed to save";
        var severity = Severity.Error;
        if(saveOnTBR(book)){
            message = "Book Saved Successfully!";
            severity =  Severity.Success;
            Console.WriteLine("aaaaaaa");
        }
        
        Snackbar.Add(message, severity, config =>
        {
            config.ShowCloseIcon = true;
        });
    }
}